\documentclass[12pt,a4paper,openany]{book}

% è®¾ç½®åŸºç¡€è¡Œé—´è·å’Œæ®µè½é—´è·
\linespread{1.2}  % å¢åŠ è¡Œé—´è·ï¼Œä»é»˜è®¤çš„1.0æå‡åˆ°1.2

% --- Packages ---
\usepackage{iftex}
\usepackage{eso-pic}  % For background image placement
\usepackage{xstring}  % For string comparison in conditionals

% Define allowbreak command early to prevent undefined control sequence errors
% This is needed by the table-wrap filter which inserts \allowbreak commands
% Use a more robust definition that works in all contexts including textbf
\DeclareRobustCommand{\allowbreak}{\discretionary{}{}{}}

% Engine compatibility check and optimization recommendations
% The PDF generation tool automatically selects the optimal LaTeX engine:
% - LuaLaTeX: Used when emoji support is enabled (--emoji flag)
% - XeLaTeX: Used for standard multilingual content without emoji
%
% Engine selection rationale:
% - LuaLaTeX provides better emoji font handling and Unicode support
% - XeLaTeX offers faster compilation for non-emoji content
% - Both engines support CJK (Chinese, Japanese, Korean) text rendering
$if(emoji)$
\ifluatex\else
  \PackageWarning{template}{Emoji and multilingual support works best with LuaLaTeX engine. Consider using --engine=lualatex.}
\fi
$endif$

% LuaLaTeX multilingual font configuration
% 
% LuaLaTeX provides superior font handling through:
% 1. HarfBuzz text shaping engine for complex scripts
% 2. Native OpenType feature support
% 3. Better Unicode normalization
% 4. Advanced font fallback mechanisms
%
% HarfBuzz renderer benefits:
% - Proper CJK character shaping and spacing
% - Complex script support (Arabic, Devanagari, etc.)
% - Advanced typography features (ligatures, kerning)
% - Emoji and color font support
\ifluatex
  \usepackage{fontspec}
  \defaultfontfeatures{Renderer=HarfBuzz}

  % Configure main font with comprehensive CJK support
  % 
  % Font selection priority:
  % 1. Source Han Sans SC - Adobe/Google's pan-CJK font family
  %    - Covers Simplified Chinese, Japanese, Korean
  %    - Excellent Unicode coverage and glyph quality
  %    - Professional typography features
  % 2. Noto Sans CJK SC - Google's alternative CJK solution
  %    - Similar coverage to Source Han Sans
  %    - Open source and widely available
  % 3. PingFang SC - Apple's system font for Chinese (macOS)
  %    - High-quality rendering on Apple systems
  %    - Optimized for screen and print display
  \IfFontExistsTF{Source Han Sans SC}{
    \setmainfont{Source Han Sans SC}[
      Scale=1.0,
      UprightFont=Source Han Sans SC Regular,
      BoldFont=Source Han Sans SC Bold,
      ItalicFont=Source Han Sans SC Regular,
      BoldItalicFont=Source Han Sans SC Bold,
      Renderer=HarfBuzz
    ]
    \setsansfont{Source Han Sans SC}[
      Scale=1.0,
      UprightFont=Source Han Sans SC Regular,
      BoldFont=Source Han Sans SC Bold,
      Renderer=HarfBuzz
    ]
    \typeout{Set main font to Source Han Sans SC for comprehensive CJK support}
  }{
    \IfFontExistsTF{Noto Sans CJK SC}{
      \setmainfont{Noto Sans CJK SC}[
        Scale=1.0,
        BoldFont=Noto Sans CJK SC Bold,
        Renderer=HarfBuzz
      ]
      \setsansfont{Noto Sans CJK SC}[
        Scale=1.0,
        BoldFont=Noto Sans CJK SC Bold,
        Renderer=HarfBuzz
      ]
      \typeout{Set main font to Noto Sans CJK SC}
    }{
      \IfFontExistsTF{PingFang SC}{
        \setmainfont{PingFang SC}[
          Scale=1.0,
          BoldFont=PingFang SC Semibold,
          Renderer=HarfBuzz
        ]
        \typeout{Set main font to PingFang SC (macOS fallback)}
      }{
        \typeout{Warning: No suitable CJK font found}
      }
    }
  }
\else
  % XeLaTeX fallback configuration
  % 
  % XeLaTeX approach for CJK text:
  % 1. fontspec package for OpenType font support
  % 2. xeCJK package for Chinese, Japanese, Korean text handling
  % 3. Automatic font switching between Latin and CJK scripts
  % 4. Maintains compatibility with older LaTeX documents
  %
  % XeLaTeX benefits:
  % - Faster compilation than LuaLaTeX for simple documents
  % - Wide package compatibility
  % - Stable and well-tested CJK support
  \usepackage{fontspec}
  \usepackage{xeCJK}

  % Configure main fonts for XeLaTeX
  \IfFontExistsTF{Source Han Sans SC}{
    \setmainfont{Source Han Sans SC}[
      Scale=1.0,
      BoldFont=Source Han Sans SC Bold,
      Renderer=HarfBuzz
    ]
    \setCJKmainfont{Source Han Sans SC}[
      Scale=1.0,
      BoldFont=Source Han Sans SC Bold
    ]
    \typeout{Set fonts to Source Han Sans SC (XeLaTeX)}
  }{
    \typeout{Using default fonts (XeLaTeX)}
  }
\fi


% Enhanced multilingual font support (CJK and emoji)
% 
% This section configures specialized fonts for:
% 1. Japanese text (Hiragana, Katakana, Kanji)
% 2. Korean text (Hangul, Hanja)
% 3. Emoji and pictographic symbols
% 4. Proper font fallback chains
%
% Benefits of separate font families:
% - Language-specific glyph variants (e.g., Chinese vs Japanese Kanji)
% - Optimized character spacing and metrics
% - Cultural typography preferences
% - Better rendering quality for each script
\ifluatex
  % LuaLaTeX multilingual font configuration
  % Uses newfontfamily to define specialized font commands
  % é…ç½®æ—¥æ–‡å­—ä½“
  \IfFontExistsTF{Source Han Sans JP}{
    \newfontfamily\jpfont{Source Han Sans JP}[
      BoldFont=Source Han Sans JP Bold,
      Renderer=HarfBuzz
    ]
    \typeout{Set Japanese font to Source Han Sans JP}
  }{
    \IfFontExistsTF{Hiragino Sans}{
      \newfontfamily\jpfont{Hiragino Sans}[
        BoldFont=Hiragino Sans W6,
        Renderer=HarfBuzz
      ]
      \typeout{Set Japanese font to Hiragino Sans}
    }{
      \let\jpfont\rmfamily
      \typeout{No Japanese font available, using main font}
    }
  }

  % é…ç½®éŸ©æ–‡å­—ä½“
  \IfFontExistsTF{Source Han Sans KR}{
    \newfontfamily\krfont{Source Han Sans KR}[
      BoldFont=Source Han Sans KR Bold,
      Renderer=HarfBuzz
    ]
    \typeout{Set Korean font to Source Han Sans KR}
  }{
    \IfFontExistsTF{Apple SD Gothic Neo}{
      \newfontfamily\krfont{Apple SD Gothic Neo}[
        BoldFont=Apple SD Gothic Neo Bold,
        Renderer=HarfBuzz
      ]
      \typeout{Set Korean font to Apple SD Gothic Neo}
    }{
      \let\krfont\rmfamily
      \typeout{No Korean font available, using main font}
    }
  }
\else
  % XeLaTeX çš„å¤šè¯­è¨€å­—ä½“é…ç½®
  \IfFontExistsTF{Source Han Sans JP}{
    \setCJKfamilyfont{jp}{Source Han Sans JP}[
      BoldFont=Source Han Sans JP Bold
    ]
    \newcommand{\jpfont}{\CJKfamily{jp}}
    \typeout{Set Japanese font to Source Han Sans JP (XeLaTeX)}
  }{
    \newcommand{\jpfont}{}
    \typeout{No Japanese font available (XeLaTeX)}
  }

  \IfFontExistsTF{Source Han Sans KR}{
    \setCJKfamilyfont{kr}{Source Han Sans KR}[
      BoldFont=Source Han Sans KR Bold
    ]
    \newcommand{\krfont}{\CJKfamily{kr}}
    \typeout{Set Korean font to Source Han Sans KR (XeLaTeX)}
  }{
    \newcommand{\krfont}{}
    \typeout{No Korean font available (XeLaTeX)}
  }
\fi

$if(emoji)$
% é…ç½® emoji å­—ä½“ - é’ˆå¯¹ LuaLaTeX å’Œ XeLaTeX ä¼˜åŒ–
\ifluatex
  % LuaLaTeX emoji å­—ä½“é…ç½®
  \IfFontExistsTF{Apple Color Emoji}{
    \newfontfamily\emojifont{Apple Color Emoji}[
      Renderer=HarfBuzz
    ]
    \typeout{Set emoji font to Apple Color Emoji (LuaLaTeX)}
  }{
    \IfFontExistsTF{Noto Color Emoji}{
      \newfontfamily\emojifont{Noto Color Emoji}[
        Renderer=HarfBuzz
      ]
      \typeout{Set emoji font to Noto Color Emoji (LuaLaTeX)}
    }{
      \IfFontExistsTF{Segoe UI Emoji}{
        \newfontfamily\emojifont{Segoe UI Emoji}[
          Renderer=HarfBuzz
        ]
        \typeout{Set emoji font to Segoe UI Emoji (LuaLaTeX)}
      }{
        \IfFontExistsTF{Noto Emoji}{
          \newfontfamily\emojifont{Noto Emoji}[
            Renderer=HarfBuzz
          ]
          \typeout{Set emoji font to Noto Emoji (LuaLaTeX)}
        }{
          % ä½¿ç”¨ç¬¦å·å­—ä½“ä½œä¸º fallback
          \IfFontExistsTF{Arial Unicode MS}{
            \newfontfamily\emojifont{Arial Unicode MS}[
              Renderer=HarfBuzz
            ]
            \typeout{Set emoji font to Arial Unicode MS (LuaLaTeX fallback)}
          }{
            \let\emojifont\rmfamily
            \typeout{Warning: No emoji font found (LuaLaTeX), using main font}
          }
        }
      }
    }
  }
\else
  % XeLaTeX emoji å­—ä½“é…ç½®
  \IfFontExistsTF{Apple Color Emoji}{
    \newfontfamily\emojifont{Apple Color Emoji}[
      Renderer=HarfBuzz,
      RawFeature={color=1}
    ]
    \typeout{Set emoji font to Apple Color Emoji with color support (XeLaTeX)}
  }{
    \IfFontExistsTF{Noto Color Emoji}{
      \newfontfamily\emojifont{Noto Color Emoji}[
        Renderer=HarfBuzz,
        RawFeature={color=1}
      ]
      \typeout{Set emoji font to Noto Color Emoji with color support (XeLaTeX)}
    }{
      \IfFontExistsTF{Arial Unicode MS}{
        \newfontfamily\emojifont{Arial Unicode MS}
        \typeout{Set emoji font to Arial Unicode MS (XeLaTeX fallback)}
      }{
        \let\emojifont\rmfamily
        \typeout{Warning: No emoji font found (XeLaTeX), using main font}
      }
    }
  }
\fi

% é…ç½®ä¸­æ–‡æ”¯æŒ
\ifluatex
  % LuaLaTeX ä¸­æ–‡é…ç½® - ä½¿ç”¨ fontset=none é¿å…é»˜è®¤å­—ä½“å†²çª
  \usepackage[UTF8,fontset=none]{ctex}

  % æ‰‹åŠ¨é…ç½® ctex å­—ä½“ï¼Œä½¿ç”¨æˆ‘ä»¬å·²ç»è®¾ç½®çš„å­—ä½“
  \IfFontExistsTF{Source Han Sans SC}{
    \setCJKmainfont{Source Han Sans SC}[
      BoldFont=Source Han Sans SC Bold
    ]
    \setCJKsansfont{Source Han Sans SC}[
      BoldFont=Source Han Sans SC Bold
    ]
    \setCJKmonofont{Source Han Mono SC}[
      BoldFont=Source Han Mono SC Bold
    ]
    \typeout{Configured ctex with Source Han Sans SC (LuaLaTeX)}
  }{
    \typeout{Warning: Source Han Sans SC not found for ctex (LuaLaTeX)}
  }
\else
  % XeLaTeX ä¸­æ–‡é…ç½®
  \usepackage[UTF8]{ctex}
  \typeout{Using ctex for Chinese support (XeLaTeX)}
\fi

% é…ç½®ä¸­è‹±æ–‡é—´è·ï¼ˆctex ä¼šè‡ªåŠ¨å¤„ç†ï¼‰
\ctexset{
  punct=quanjiao,
  space=auto,
  autoindent=true
}

% é…ç½®ç¬¦å·å­—ä½“ï¼ˆç”¨äºç‰¹æ®Šç¬¦å·å’Œ emoji fallbackï¼‰
\IfFontExistsTF{Noto Sans Symbols}{
  \newfontfamily\symbolfont{Noto Sans Symbols}
  \typeout{Set symbol font to Noto Sans Symbols}
}{
  \IfFontExistsTF{Segoe UI Symbol}{
    \newfontfamily\symbolfont{Segoe UI Symbol}
    \typeout{Set symbol font to Segoe UI Symbol}
  }{
    \IfFontExistsTF{Arial Unicode MS}{
      \newfontfamily\symbolfont{Arial Unicode MS}
      \typeout{Set symbol font to Arial Unicode MS}
    }{
      \let\symbolfont\rmfamily
      \typeout{Warning: No symbol font found}
    }
  }
}
$else$
% é emoji æ¨¡å¼ä¸‹ä¹Ÿé…ç½®ç¬¦å·å­—ä½“
\IfFontExistsTF{Noto Sans Symbols}{
  \newfontfamily\symbolfont{Noto Sans Symbols}
  \typeout{Set symbol font to Noto Sans Symbols}
}{
  \IfFontExistsTF{Arial Unicode MS}{
    \newfontfamily\symbolfont{Arial Unicode MS}
    \typeout{Set symbol font to Arial Unicode MS}
  }{
    \let\symbolfont\rmfamily
    \typeout{Warning: No symbol font found}
  }
}
$endif$

\usepackage{geometry}
\usepackage{fancyhdr}
\usepackage{titlesec}
\usepackage{graphicx}
\usepackage[dvipsnames]{xcolor}
\usepackage{longtable}
\usepackage{array}
\usepackage{booktabs}
\usepackage{colortbl}
\usepackage{caption}
\usepackage{float}
\usepackage{chngcntr}
\usepackage{pdfpages}
\usepackage{parskip}
\usepackage{listings}
\usepackage{minted}
\usepackage{fvextra}
\usepackage{amsmath}  % Required for mathematical environments like align
\usepackage{amssymb}
\usepackage{hyperref}
\usepackage{bookmark}
\usepackage{tocloft}
\usepackage{tabularx}
\usepackage{makecell}
\usepackage{enumitem}
\usepackage[normalem]{ulem}  % For strikethrough (\sout) and underline commands, normalem preserves \emph
% \usepackage{soul}  % Commented out due to conflicts with ulem and CJK text
\usepackage{tikz}  % Required for mdframed with framemethod=tikz
\usetikzlibrary{calc}  % Required for mdframed breakable frames
\usepackage{seqsplit}  % For breaking long sequences like URLs and code

% --- Pandoc Compatibility ---
\providecommand{\tightlist}{%
  \setlength{\itemsep}{2pt}\setlength{\parskip}{4pt}}  % å¢åŠ åˆ—è¡¨é¡¹é—´è·å’Œæ®µè½é—´è·
\newcommand{\passthrough}[1]{#1}

% Define missing text formatting commands
\providecommand{\st}[1]{\sout{#1}}  % Strikethrough using ulem package
\providecommand{\textsubscript}[1]{\ensuremath{_{\text{#1}}}}  % Subscript
\providecommand{\textsuperscript}[1]{\ensuremath{^{\text{#1}}}}  % Superscript (if not already defined)
\providecommand{\smallcaps}[1]{\textsc{#1}}  % Small caps
\providecommand{\texthl}[1]{\uline{#1}}  % Highlight using ulem underline

% Additional Pandoc-generated commands
\providecommand{\oldspacing}{}  % Backup for spacing changes
\providecommand{\subtitle}[1]{#1}  % Subtitle command

%%%% Table layout section
% This section configures table formatting and layout options
% Uses 'tabularx' and 'makecell' packages for better table handling
% --- Table Column Types ---
% Define auto-wrapping column types
\renewcommand\tabularxcolumn[1]{p{#1}} % top alignment

% For standard (non-tabularx) tables produced by Pandoc, provide better column handling
% Instead of overriding all tables, let Pandoc handle column specs and just ensure consistent formatting
\let\oldtabular\tabular
\renewcommand{\tabular}[1]{%
  \oldtabular{#1}% Use Pandoc's column specification
}

% åŸºæœ¬è¡¨æ ¼æ”¯æŒ - å¢å¼ºè¡¨æ ¼çº¿æ¡ï¼Œä½¿ç”¨æµ…ç°è‰²åˆ†éš”çº¿
\definecolor{tablegraylightline}{gray}{0.7}  % å®šä¹‰æµ…ç°è‰²
\arrayrulecolor{tablegraylightline}  % è®¾ç½®è¡¨æ ¼çº¿æ¡é¢œè‰²ä¸ºæµ…ç°è‰²
\renewcommand{\toprule}{\hline}
\renewcommand{\midrule}{\hline}
\renewcommand{\bottomrule}{\hline}
\renewcommand{\arraystretch}{1.6}
\setlength{\arrayrulewidth}{0.5pt}

% å®šä¹‰è¡¨æ ¼åˆ—ç±»å‹ - ä½¿ç”¨æ›´åˆç†çš„å®½åº¦åˆ†é…
\newcolumntype{L}{>{\raggedright\arraybackslash}p{0.33\textwidth}}
\newcolumntype{C}{>{\centering\arraybackslash}p{0.33\textwidth}}
\newcolumntype{R}{>{\raggedleft\arraybackslash}p{0.33\textwidth}}

%%%% Code highlight section
% This section configures syntax highlighting for code blocks in various languages
% Uses both 'listings' and 'minted' packages for comprehensive code formatting
% 'minted' provides better syntax highlighting via Pygments for modern languages
% --- Minted Configuration ---
% Note: minted environments are created by the minted-filter.lua Lua filter
% This filter converts fenced code blocks to proper minted environments with language detection

% ä½¿ç”¨ mdframed åŒ…æ¥åˆ›å»ºç»Ÿä¸€çš„ä»£ç å—æ ·å¼
\usepackage[framemethod=tikz]{mdframed}

% å®šä¹‰å¼•ç”¨å—æ ·å¼ - å·¦ä¾§ç«–çº¿
\definecolor{quoteborder}{rgb}{0.4,0.4,0.4}  % å¼•ç”¨å—å·¦ä¾§ç«–çº¿é¢œè‰² - æ›´æ·±çš„ç°è‰²ä½¿ç«–çº¿æ›´æ˜æ˜¾
\definecolor{quotebg}{rgb}{0.975,0.975,0.975}   % å¼•ç”¨å—èƒŒæ™¯è‰²ï¼ˆéå¸¸æµ…çš„ç°è‰²ï¼‰

% å®šä¹‰å¼•ç”¨å—æ¡†æ¶æ ·å¼
\mdfdefinestyle{quotestyle}{
    backgroundcolor=quotebg,
    linecolor=quoteborder,
    linewidth=4pt,           % å·¦ä¾§ç«–çº¿å®½åº¦ - å¢åŠ åˆ° 4pt ä½¿ç«–çº¿æ›´æ˜æ˜¾
    leftline=true,           % åªæ˜¾ç¤ºå·¦ä¾§çº¿
    rightline=false,
    topline=false,
    bottomline=false,
    leftmargin=8pt,          % å¤–éƒ¨å·¦è¾¹è·ï¼Œä½¿æ•´ä¸ªå¼•ç”¨å—å‘å³ç¼©è¿›
    rightmargin=0pt,
    innerleftmargin=20pt,    % å·¦ä¾§å†…è¾¹è·ï¼Œæ–‡æœ¬ä¸ç«–çº¿çš„è·ç¦»
    innerrightmargin=12pt,
    innertopmargin=10pt,     % å¢åŠ ä¸Šä¸‹å†…è¾¹è·
    innerbottommargin=10pt,
    skipabove=20pt,          % å¼•ç”¨å—å‰çš„é—´è·ï¼Œå¢åŠ ä¸æ®µè½çš„åŒºåˆ†
    skipbelow=20pt,          % å¼•ç”¨å—åçš„é—´è·ï¼Œå¢åŠ ä¸æ®µè½çš„åŒºåˆ†
    roundcorner=0pt,
    splittopskip=\topskip,   % è·¨é¡µæ—¶é¡¶éƒ¨é—´è·
    splitbottomskip=0pt,     % è·¨é¡µæ—¶åº•éƒ¨é—´è·
    everyline=true           % æ¯ä¸€è¡Œéƒ½åº”ç”¨æ ·å¼
}

% å®šä¹‰ç»Ÿä¸€çš„ä»£ç å—æ¡†æ¶æ ·å¼ - ä¸ºè¡Œå·é¢„ç•™å·¦è¾¹è·
\mdfdefinestyle{codeblockstyle}{
    backgroundcolor=shadecolor,
    linecolor=codeciteborder,
    linewidth=1pt,
    leftmargin=0pt,
    rightmargin=0pt,
    innerleftmargin=18pt,  % å‡å°‘å·¦è¾¹è·ï¼Œè®©è¡Œå·æ›´é è¿‘è¾¹æ¡†ï¼ˆ25pt é€‚åˆä¸‰ä½æ•°è¡Œå·ï¼‰
    innerrightmargin=12pt,
    innertopmargin=6pt,   % å‡å°‘ä¸Šè¾¹è·ï¼Œè®©ä»£ç æ›´é è¿‘è¾¹æ¡†é¡¶éƒ¨
    innerbottommargin=6pt, % å‡å°‘ä¸‹è¾¹è·ï¼Œè®©ä»£ç æ›´é è¿‘è¾¹æ¡†åº•éƒ¨
    skipabove=18pt,          % ä»£ç å—å‰çš„é—´è·ï¼Œå¢åŠ ä¸æ®µè½çš„åŒºåˆ†
    skipbelow=18pt,          % ä»£ç å—åçš„é—´è·ï¼Œå¢åŠ ä¸æ®µè½çš„åŒºåˆ†
    roundcorner=0pt,
    splittopskip=\topskip, % è·¨é¡µæ—¶é¡¶éƒ¨é—´è·
    splitbottomskip=0pt,   % è·¨é¡µæ—¶åº•éƒ¨é—´è·
    everyline=true         % æ¯ä¸€è¡Œéƒ½åº”ç”¨æ ·å¼
}

% Configure minted global settings - line number position and color control
\setminted{
    linenos=true,
    numbersep=6pt,       % Reduce distance between line numbers and code content (6pt for closer spacing)
    xleftmargin=0pt,     % No negative margin to ensure line numbers stay inside border
    xrightmargin=0pt,    % Right margin of code block
    resetmargins=false,  % Keep margin settings
    fontsize=\scriptsize,
    breaklines=true,
    breakanywhere=true,
    tabsize=2,
    samepage=false
}

% è‡ªå®šä¹‰è¡Œå·é¢œè‰² - ä½¿ç”¨æµ…ç°è‰²
\renewcommand{\theFancyVerbLine}{\textcolor{linenumbercolor}{\scriptsize\arabic{FancyVerbLine}}}

% å®šä¹‰ Shaded ç¯å¢ƒç”¨äº Pandoc ç”Ÿæˆçš„ä»£ç å—
\usepackage{fancyvrb}
\usepackage{framed}
\setlength{\FrameSep}{12pt}  % è®¾ç½®æ¡†æ¶å†…è¾¹è·

% é‡æ–°å®šä¹‰ shadecolor - ä½¿ç”¨æ›´æµ…çš„èƒŒæ™¯è‰²å’Œè¾¹æ¡†
\definecolor{shadecolor}{rgb}{0.97,0.97,0.98}  % æ›´æµ…çš„èƒŒæ™¯è‰²
\definecolor{codeciteborder}{rgb}{0.85,0.87,0.90}  % æ›´æµ…çš„è¾¹æ¡†é¢œè‰²
\definecolor{linenumbercolor}{rgb}{0.65,0.65,0.65}  % è¡Œå·é¢œè‰² - æµ…ç°è‰²

% å®šä¹‰ Shaded ç¯å¢ƒä½¿ç”¨è‡ªå®šä¹‰æ¡†æ¶ï¼Œç¡®ä¿æ­£ç¡®è·¨é¡µ
\newenvironment{Shaded}{%
  \def\FrameCommand{%
    \fboxsep=\FrameSep%
    \fcolorbox{codeciteborder}{shadecolor}%
  }%
  \MakeFramed{\FrameRestore}%
  \vspace{-6pt}%  % å‡å°‘é¡¶éƒ¨é—´è·
}{%
  \vspace{-6pt}%  % å‡å°‘åº•éƒ¨é—´è·
  \endMakeFramed%
}

% å®šä¹‰ Highlighting ç¯å¢ƒç”¨äºè¯­æ³•é«˜äº® - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä¸è¾¹æ¡†å®Œç¾é…åˆ
\newenvironment{Highlighting}{%
$if(emoji)$
  \emojicodefont\scriptsize%  % ä½¿ç”¨æ”¯æŒ emoji çš„ä»£ç å­—ä½“ï¼Œæ›´å°å­—å·
$else$
  \codefont\scriptsize%  % ä½¿ç”¨æ”¯æŒä¸­æ–‡çš„ä»£ç å­—ä½“ï¼Œæ›´å°å­—å·
$endif$
  \setlength{\parindent}{0pt}%
  \setlength{\leftskip}{0pt}%  % å‡å°‘å·¦è¾¹è·ï¼Œè®©å†…å®¹æ›´è´´è¿‘è¾¹æ¡†
  \setlength{\rightskip}{0pt}%  % å‡å°‘å³è¾¹è·
  \setlength{\topsep}{0pt}%
  \setlength{\partopsep}{0pt}%
  \setlength{\parsep}{0pt}%
  \setlength{\itemsep}{0pt}%
}{%
}

% å®šä¹‰ Pandoc è¯­æ³•é«˜äº®å‘½ä»¤ - ä¼˜åŒ–é¢œè‰²å¯¹æ¯”åº¦
\newcommand{\CommentTok}[1]{\textcolor{syntaxgreen}{\textit{#1}}}
\newcommand{\KeywordTok}[1]{\textcolor{syntaxblue}{\textbf{#1}}}
\newcommand{\StringTok}[1]{\textcolor{syntaxred}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor{syntaxpurple}{\textbf{#1}}}
\newcommand{\OperatorTok}[1]{\textcolor{syntaxbrown}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\BuiltInTok}[1]{\textcolor{syntaxdarkblue}{\textbf{#1}}}
\newcommand{\ControlFlowTok}[1]{\textcolor{syntaxblue}{\textbf{#1}}}
\newcommand{\AttributeTok}[1]{\textcolor{syntaxorange}{\textbf{#1}}}
\newcommand{\VariableTok}[1]{\textcolor{syntaxdarkblue}{#1}}
\newcommand{\DataTypeTok}[1]{\textcolor{syntaxpurple}{#1}}
\newcommand{\DecValTok}[1]{\textcolor{syntaxorange}{#1}}
\newcommand{\FloatTok}[1]{\textcolor{syntaxorange}{#1}}
\newcommand{\CharTok}[1]{\textcolor{syntaxred}{#1}}
\newcommand{\SpecialCharTok}[1]{\textcolor{syntaxbrown}{\textbf{#1}}}
\newcommand{\VerbatimStringTok}[1]{\textcolor{syntaxred}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor{syntaxred}{\textbf{#1}}}
\newcommand{\ImportTok}[1]{\textcolor{syntaxdarkblue}{\textbf{#1}}}
\newcommand{\DocumentationTok}[1]{\textcolor{syntaxgreen}{\textit{#1}}}
\newcommand{\AnnotationTok}[1]{\textcolor{syntaxgreen}{\textbf{\textit{#1}}}}
\newcommand{\CommentVarTok}[1]{\textcolor{syntaxgreen}{\textbf{\textit{#1}}}}
\newcommand{\InformationTok}[1]{\textcolor{syntaxgreen}{\textbf{\textit{#1}}}}
\newcommand{\WarningTok}[1]{\textcolor{syntaxorange}{\textbf{\textit{#1}}}}
\newcommand{\AlertTok}[1]{\textcolor{syntaxred}{\textbf{#1}}}
\newcommand{\ErrorTok}[1]{\textcolor{red}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\PreprocessorTok}[1]{\textcolor{syntaxbrown}{\textbf{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\OtherTok}[1]{\textcolor{syntaxdarkblue}{#1}}

% Define syntax highlighting colors for text-only highlighting
\definecolor{syntaxblue}{rgb}{0.0,0.0,0.8}        % Keywords
\definecolor{syntaxgreen}{rgb}{0.0,0.5,0.0}       % Comments
\definecolor{syntaxred}{rgb}{0.8,0.0,0.0}         % Strings
\definecolor{syntaxpurple}{rgb}{0.5,0.0,0.5}      % Functions
\definecolor{syntaxorange}{rgb}{0.8,0.4,0.0}      % Numbers
\definecolor{syntaxgray}{rgb}{0.5,0.5,0.5}        % Line numbers
\definecolor{syntaxdarkblue}{rgb}{0.0,0.0,0.5}    % Types
\definecolor{syntaxbrown}{rgb}{0.6,0.3,0.0}       % Operators



% --- Enhanced Listings Configuration for Fallback ---
\definecolor{codegray}{gray}{0.95}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codered}{rgb}{0.6,0,0}
\definecolor{backcolour}{rgb}{0.94,0.95,0.96}  % æ›´æ˜æ˜¾çš„èƒŒæ™¯è‰²ï¼Œä¸ Shaded ç¯å¢ƒä¸€è‡´
\definecolor{framegray}{rgb}{0.75,0.80,0.85}  % æ›´æ˜æ˜¾çš„è¾¹æ¡†é¢œè‰²

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},
    commentstyle=\color{codegreen}\itshape,
    keywordstyle=\color{blue}\bfseries,
    numberstyle=\tiny\color{gray},
    stringstyle=\color{codepurple},
    basicstyle=\codefont\scriptsize,
    breakatwhitespace=false,
    breaklines=true,
    captionpos=b,
    keepspaces=true,
    numbers=left,
    numbersep=12pt,  % è¡Œå·ä¸ä»£ç çš„é—´è·
    showspaces=false,
    showstringspaces=false,
    showtabs=false,
    tabsize=2,
    frame=single,
    frameround=tttt,
    rulecolor=\color{framegray},
    framesep=12pt,  % è¾¹æ¡†å†…è¾¹è·ï¼Œç¡®ä¿è¡Œå·åœ¨è¾¹æ¡†å†…
    framexleftmargin=0pt,  % ä¸é¢å¤–å¢åŠ å·¦è¾¹è·ï¼Œè®©è¡Œå·ç´§è´´è¾¹æ¡†
    framexrightmargin=0pt,  % ä¸é¢å¤–å¢åŠ å³è¾¹è·
    framextopmargin=8pt,  % ä¸Šè¾¹è·
    framexbottommargin=8pt,  % ä¸‹è¾¹è·
    xleftmargin=0pt,  % æ•´ä½“å·¦è¾¹è·è®¾ä¸º 0ï¼Œè®©è¾¹æ¡†åŒ…å«è¡Œå·
    xrightmargin=0pt,  % æ•´ä½“å³è¾¹è·è®¾ä¸º 0
    aboveskip=12pt,  % ä»£ç å—ä¸Šæ–¹é—´è·
    belowskip=12pt  % ä»£ç å—ä¸‹æ–¹é—´è·
}

% å®šä¹‰ç‰¹å®šè¯­è¨€çš„æ ·å¼
\lstdefinelanguage{YAML}{
  keywords={true,false,null,yes,no},
  keywordstyle=\color{blue}\bfseries,
  ndkeywords={},
  ndkeywordstyle=\color{codered}\bfseries,
  identifierstyle=\color{black},
  sensitive=false,
  comment=[l]{\#},
  morecomment=[s]{/*}{*/},
  commentstyle=\color{codegreen}\itshape,
  stringstyle=\color{codepurple},
  morestring=[b]',
  morestring=[b]"
}

\lstdefinelanguage{Bash}{
  morekeywords={if,then,fi,else,elif,for,in,do,done,case,esac,while,function,local,export},
  sensitive=true,
  alsoletter={-}, % allow flags like --help
  comment=[l]{\#}
}

\lstdefinelanguage{shell}{
  morekeywords={if,then,fi,else,elif,for,in,do,done,case,esac,while,function,local,export},
  sensitive=true,
  alsoletter={-}, % allow flags like --help
  comment=[l]{\#}
}

\lstdefinelanguage{Go}{
  morekeywords={break,case,chan,const,continue,default,defer,else,fallthrough,for,func,go,goto,if,import,interface,map,package,range,return,select,struct,switch,type,var},
  sensitive=true,
  comment=[l]{//},
  morecomment=[s]{/*}{*/}
}

\lstdefinelanguage{TOML}{
  morekeywords={true,false},
  sensitive=true,
  comment=[l]{\#}
}

\lstdefinelanguage{HTML}{
  morekeywords={html,head,body,title,div,span,p,a,img,ul,ol,li,table,tr,td,th,form,input,button,script,style,meta,link},
  sensitive=false,
  comment=[s]{<!--}{-->}
}

\lstdefinelanguage{XML}{
  morekeywords={xml,version,encoding,stylesheet,schema,namespace},
  sensitive=false,
  comment=[s]{<!--}{-->}
}

\lstdefinelanguage{Markdown}{
  morekeywords={},
  sensitive=true,
  comment=[l]{<!--}
}

\lstdefinelanguage{Rust}{
  morekeywords={as,break,const,continue,crate,else,enum,extern,false,fn,for,if,in,let,loop,match,mod,move,mut,pub,ref,return,self,Self,static,struct,super,trait,true,type,unsafe,use,where,while},
  sensitive=true,
  comment=[l]{//},
  morecomment=[s]{/*}{*/}
}

\lstdefinelanguage{Python}{
  morekeywords={and,as,assert,break,class,continue,def,del,elif,else,except,exec,finally,for,from,global,if,import,in,is,lambda,not,or,pass,print,raise,return,try,while,with,yield},
  sensitive=true,
  comment=[l]{\#}
}

\lstdefinelanguage{JSON}{
  morekeywords={},
  sensitive=true,
  comment=[l]{//}
}

\lstdefinelanguage{Dockerfile}{
  morekeywords={FROM,RUN,CMD,LABEL,EXPOSE,ENV,ADD,COPY,ENTRYPOINT,VOLUME,USER,WORKDIR,ARG,ONBUILD,STOPSIGNAL,HEALTHCHECK,SHELL},
  sensitive=false,
  comment=[l]{\#}
}

\lstdefinelanguage{INI}{
  morekeywords={},
  sensitive=true,
  comment=[l]{\#},
  morecomment=[l]{;}
}

\lstdefinelanguage{JavaScript}{
  morekeywords={break,case,catch,continue,debugger,default,delete,do,else,finally,for,function,if,in,instanceof,new,return,switch,this,throw,try,typeof,var,void,while,with,const,let,class,extends,super,import,export,from,async,await},
  sensitive=true,
  comment=[l]{//},
  morecomment=[s]{/*}{*/}
}

\lstdefinelanguage{Text}{}
\lstset{language=Text}

% Language alias mapping macro
\providecommand{\lstalias}[2]{\expandafter\lstdefinelanguage\expandafter{#1}[]{#2}{}}

% Helper aliases so Pandoc names match ours
\lstalias{shell}{Bash}
\lstalias{sh}{Bash}
\lstalias{go}{Go}
\lstalias{python}{Python}
\lstalias{javascript}{JavaScript}
\lstalias{js}{JavaScript}
\lstalias{yaml}{YAML}
\lstalias{yml}{YAML}
\lstalias{json}{JSON}
\lstalias{html}{HTML}
\lstalias{xml}{XML}
\lstalias{toml}{TOML}
\lstalias{dockerfile}{Dockerfile}
\lstalias{rust}{Rust}
\lstalias{rs}{Rust}
\lstalias{markdown}{Markdown}
\lstalias{md}{Markdown}
\lstalias{ini}{INI}
\lstalias{text}{Text}
\lstalias{txt}{Text}
\lstalias{go-html-template}{Go}
\lstalias{gotemplate}{Go}

\lstset{
  style=mystyle,
  columns=fixed,
  keepspaces=true
}


% ä¸ºä¸åŒè¯­è¨€è®¾ç½®ç‰¹å®šæ ·å¼
\lstset{
    language=YAML,
    morekeywords={apiVersion,kind,metadata,spec,data,name,namespace,labels,annotations}
}

% --- Document Layout ---
% Figure numbering by chapter
\counterwithin{figure}{chapter}
\renewcommand{\thefigure}{\thechapter-\arabic{figure}}
\captionsetup{labelsep=colon, font=normal} % å°† labelsep=space æ”¹ä¸º colon
\renewcommand{\figurename}{å›¾}

% ä¼˜åŒ–å›¾ç‰‡æµ®åŠ¨å’Œé—´è·è®¾ç½®
\setlength{\floatsep}{12pt plus 2pt minus 2pt}     % æµ®åŠ¨ä½“ä¸æµ®åŠ¨ä½“ä¹‹é—´çš„é—´è·
\setlength{\textfloatsep}{12pt plus 2pt minus 2pt} % æµ®åŠ¨ä½“ä¸æ­£æ–‡ä¹‹é—´çš„é—´è·
\setlength{\intextsep}{12pt plus 2pt minus 2pt}    % åµŒå…¥æ–‡æœ¬çš„æµ®åŠ¨ä½“å‰åé—´è·
\setlength{\abovecaptionskip}{6pt}                 % å›¾ç‰‡ä¸æ ‡é¢˜ä¹‹é—´çš„é—´è·
\setlength{\belowcaptionskip}{6pt}                 % æ ‡é¢˜ä¸ä¸‹æ–‡ä¹‹é—´çš„é—´è·

% æ›´å®½æ¾çš„æµ®åŠ¨ä½“å‚æ•°
\renewcommand{\topfraction}{0.9}        % é¡µé¢é¡¶éƒ¨æµ®åŠ¨ä½“çš„æœ€å¤§æ¯”ä¾‹
\renewcommand{\bottomfraction}{0.8}     % é¡µé¢åº•éƒ¨æµ®åŠ¨ä½“çš„æœ€å¤§æ¯”ä¾‹
\renewcommand{\textfraction}{0.07}      % é¡µé¢æ–‡æœ¬çš„æœ€å°æ¯”ä¾‹
\renewcommand{\floatpagefraction}{0.7}  % æµ®åŠ¨é¡µé¢æµ®åŠ¨ä½“çš„æœ€å°æ¯”ä¾‹
\setcounter{totalnumber}{50}            % é¡µé¢æµ®åŠ¨ä½“çš„æœ€å¤§æ•°é‡
\setcounter{topnumber}{50}              % é¡µé¢é¡¶éƒ¨æµ®åŠ¨ä½“çš„æœ€å¤§æ•°é‡
\setcounter{bottomnumber}{50}           % é¡µé¢åº•éƒ¨æµ®åŠ¨ä½“çš„æœ€å¤§æ•°é‡

% Table formatting
\renewcommand{\tablename}{è¡¨}
\counterwithin{table}{chapter}
\renewcommand{\thetable}{\thechapter-\arabic{table}}

% è®¾ç½®è¡¨æ ¼æ ·å¼
\captionsetup[table]{position=top, labelsep=colon, font=normal}

% è®¾ç½®è¡¨æ ¼è¡Œé—´è·å’ŒåŸºæœ¬æ ·å¼ï¼ˆå·²åœ¨åŸºæœ¬è¡¨æ ¼æ”¯æŒéƒ¨åˆ†è®¾ç½®ï¼‰

% è®¾ç½® longtable åŸºæœ¬é—´è·
\setlength{\LTpre}{1.5em}
\setlength{\LTpost}{1.5em}

% è¡¨æ ¼ä¼˜åŒ–ï¼šé˜²æ­¢æ–‡å­—é‡å ï¼Œé€‚é…å…¨å®½åº¦è¡¨æ ¼
\setlength{\tabcolsep}{5pt} % é€‚å½“çš„åˆ—é—´è·ï¼Œé€‚é…å…¨å®½åº¦è¡¨æ ¼
\setlength{\extrarowheight}{3pt} % å¢åŠ è¡Œé«˜
\setlength{\LTcapwidth}{\textwidth} % longtable æ ‡é¢˜å®½åº¦

% è¡¨æ ¼å­—ä½“å¤§å°å’Œå®½åº¦æ§åˆ¶
\newcommand{\maxTableWidth}{\textwidth}
% Note: \tabulinesep is from longtabu package, not longtable
% For longtable, we use \arraystretch and \tabcolsep for spacing control
\newcommand{\tablefontsize}{\small}

% ä¼˜åŒ–è¡¨æ ¼åˆ†é¡µ
\setlength{\LTleft}{0pt}
\setlength{\LTright}{0pt}

% è¡¨æ ¼è‡ªåŠ¨æ¢è¡Œåˆ—ç±»å‹ï¼ˆå‚æ•°åŒ–ç‰ˆæœ¬ï¼‰- ä¼˜åŒ–ç‰ˆæœ¬
\newcolumntype{L}[1]{\u003e{\raggedright\arraybackslash}p{#1}}
\newcolumntype{C}[1]{\u003e{\centering\arraybackslash}p{#1}}
\newcolumntype{R}[1]{\u003e{\raggedleft\arraybackslash}p{#1}}

% å®šä¹‰æ›´çµæ´»çš„è‡ªåŠ¨æ¢è¡Œåˆ—ç±»å‹ï¼Œæ”¯æŒæ–­è¯
\newcolumntype{P}[1]{\u003e{\raggedright\arraybackslash\hspace{0pt}}p{#1}}
\newcolumntype{M}[1]{\u003e{\centering\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{B}[1]{\u003e{\raggedleft\arraybackslash\hspace{0pt}}b{#1}}

% Page geometry
\geometry{left=2.5cm, right=2.5cm, top=3cm, bottom=3cm, headheight=1.5cm, footskip=1cm}

% Text alignment - ensure left alignment
\raggedright
\setlength{\parindent}{0pt}
\setlength{\parskip}{8pt plus 2pt minus 1pt}  % å¢åŠ æ®µè½é—´è·ï¼Œä»3ptæå‡åˆ°8pt

% ======== è„šæ³¨æ ·å¼ä¼˜åŒ– ========
% ç°ä»£åŒ–è„šæ³¨è®¾è®¡ï¼Œæå‡è§†è§‰æ•ˆæœå’Œå¯è¯»æ€§

% åŠ è½½è„šæ³¨æ ·å¼åŒ…ï¼Œè®¾ç½®æ‚¬æŒ‚ç¼©è¿›å’Œå·¦å¯¹é½
\usepackage[hang,flushmargin]{footmisc}

% å®šä¹‰è„šæ³¨çº¿æ¡é¢œè‰² - ä½¿ç”¨æµ…ç°è‰²ï¼Œæ›´åŠ ç°ä»£ç®€æ´
\definecolor{footnoterulecolor}{RGB}{180,180,180}

% é‡æ–°å®šä¹‰è„šæ³¨çº¿æ¡æ ·å¼
\renewcommand{\footnoterule}{%
  \kern -3pt%
  {\color{footnoterulecolor}%
   \hrule width \textwidth height 0.4pt depth 0pt}%
  \kern 8pt%
}

% è„šæ³¨æ–‡æœ¬æ ·å¼ä¼˜åŒ–
\setlength{\footnotesep}{8pt}
\setlength{\skip\footins}{12pt plus 4pt minus 2pt}

% è„šæ³¨å­—ä½“å¤§å°ä¼˜åŒ–
\renewcommand{\footnotesize}{\fontsize{9}{11}\selectfont}

% é‡æ–°å®šä¹‰è„šæ³¨ç¼–å·æ ·å¼ - ä½¿ç”¨å¹³è¡Œæ•°å­—æ ¼å¼ï¼Œä¸ä½¿ç”¨ä¸Šæ ‡
\makeatletter
\renewcommand\@makefntext[1]{%
  \setlength{\parindent}{0pt}%          % æ— é¦–è¡Œç¼©è¿›
  \footnotesize\@thefnmark.\,#1%        % ç¼–å· + ç‚¹ + å°é—´è· + å†…å®¹
}
\makeatother
% ======== è„šæ³¨æ ·å¼ä¼˜åŒ–ç»“æŸ ========

% Enhanced Unicode character support and emoji fallback commands
\newcommand{\greencheckmark}{\textcolor{green}{âœ“}}
\newcommand{\redcrossmark}{\textcolor{red}{âœ—}}
\newcommand{\orangewarningmark}{\textcolor{orange}{âš }}

% Define enhanced emoji and symbol commands with intelligent fallback
% Universal emoji command that tries multiple font sources in order
\newcommand{\emoji}[1]{%
  \ifcsname emojifont\endcsname%
    \begingroup%
    \emojifont%
    #1%
    \endgroup%
  \else%
    \ifcsname symbolfont\endcsname%
      \begingroup%
      \symbolfont%
      #1%
      \endgroup%
    \else%
      #1%
    \fi%
  \fi%
}

% Smart symbol command that tries symbol font first, then emoji font
\newcommand{\smartsymbol}[1]{%
  \ifcsname symbolfont\endcsname%
    \begingroup%
    \symbolfont%
    #1%
    \endgroup%
  \else%
    \ifcsname emojifont\endcsname%
      \begingroup%
      \emojifont%
      #1%
      \endgroup%
    \else%
      #1%
    \fi%
  \fi%
}

% å®šä¹‰ä¸€ä¸ªæ›´å¼ºå¤§çš„å¤šå­—ä½“ fallback å‘½ä»¤
\newcommand{\multifont}[1]{%
  \ifcsname emojifont\endcsname%
    \begingroup%
    \emojifont%
    #1%
    \endgroup%
  \else%
    \ifcsname symbolfont\endcsname%
      \begingroup%
      \symbolfont%
      #1%
      \endgroup%
    \else%
      \ifcsname jpfont\endcsname%
        \begingroup%
        \jpfont%
        #1%
        \endgroup%
      \else%
        \ifcsname krfont\endcsname%
          \begingroup%
          \krfont%
          #1%
          \endgroup%
        \else%
          #1%
        \fi%
      \fi%
    \fi%
  \fi%
}

% Define common emoji commands with intelligent fallback
$if(emoji)$
% For emoji builds, use smart emoji command with fallback
\DeclareRobustCommand{\emojicheck}{\emoji{âœ…}}
\DeclareRobustCommand{\emojicross}{\emoji{âŒ}}
\DeclareRobustCommand{\emojiwarning}{\emoji{âš ï¸}}
\DeclareRobustCommand{\emojinote}{\emoji{ğŸ“}}
\DeclareRobustCommand{\emojitool}{\emoji{ğŸ”§}}
\DeclareRobustCommand{\emojiidea}{\emoji{ğŸ’¡}}
\DeclareRobustCommand{\emojirocket}{\emoji{ğŸš€}}
\DeclareRobustCommand{\emojichart}{\emoji{ğŸ“Š}}
\DeclareRobustCommand{\emojitarget}{\emoji{ğŸ¯}}
\DeclareRobustCommand{\emojistar}{\emoji{â­}}
$else$
% For non-emoji builds, provide text fallbacks with symbol font support
\DeclareRobustCommand{\emojicheck}{\smartsymbol{âœ“}}
\DeclareRobustCommand{\emojicross}{\smartsymbol{âœ—}}
\DeclareRobustCommand{\emojiwarning}{\smartsymbol{âš }}
\DeclareRobustCommand{\emojinote}{[NOTE]}
\DeclareRobustCommand{\emojitool}{[TOOL]}
\DeclareRobustCommand{\emojiidea}{[IDEA]}
\DeclareRobustCommand{\emojirocket}{[ROCKET]}
\DeclareRobustCommand{\emojichart}{[CHART]}
\DeclareRobustCommand{\emojitarget}{[TARGET]}
\DeclareRobustCommand{\emojistar}{[STAR]}
$endif$

% Configure symbol fonts for special characters, currency, and emoji
% Add support for missing symbols like currency symbols, punctuation, etc.
\ifluatex
  % LuaLaTeX symbol font configuration
  % Configure symbol fonts for comprehensive Unicode support
  \IfFontExistsTF{Noto Sans Symbols}{
    \newfontfamily\symbolfont{Noto Sans Symbols}[Renderer=HarfBuzz]
    \typeout{Set symbol font to Noto Sans Symbols}
  }{
    \IfFontExistsTF{Noto Sans Symbols2}{
      \newfontfamily\symbolfont{Noto Sans Symbols2}[Renderer=HarfBuzz]
      \typeout{Set symbol font to Noto Sans Symbols2}
    }{
      \IfFontExistsTF{Segoe UI Symbol}{
        \newfontfamily\symbolfont{Segoe UI Symbol}[Renderer=HarfBuzz]
        \typeout{Set symbol font to Segoe UI Symbol}
      }{
        % Use main font as fallback
        \let\symbolfont\rmfamily
        \typeout{Warning: No symbol font found, using main font}
      }
    }
  }
  
  % Currency font configuration
  \IfFontExistsTF{Noto Sans}{
    \newfontfamily\currencyfont{Noto Sans}[Renderer=HarfBuzz]
    \typeout{Set currency font to Noto Sans}
  }{
    \IfFontExistsTF{Arial Unicode MS}{
      \newfontfamily\currencyfont{Arial Unicode MS}[Renderer=HarfBuzz]
      \typeout{Set currency font to Arial Unicode MS}
    }{
      \let\currencyfont\rmfamily
      \typeout{Warning: No suitable currency font found}
    }
  }
\else
  % XeLaTeX symbol font configuration
  \IfFontExistsTF{Noto Sans Symbols}{
    \newfontfamily\symbolfont{Noto Sans Symbols}
    \typeout{Set symbol font to Noto Sans Symbols}
  }{
    \IfFontExistsTF{Segoe UI Symbol}{
      \newfontfamily\symbolfont{Segoe UI Symbol}
      \typeout{Set symbol font to Segoe UI Symbol}
    }{
      \let\symbolfont\rmfamily
      \typeout{Warning: No symbol font found for XeLaTeX}
    }
  }
  
  % Currency font for XeLaTeX
  \IfFontExistsTF{Arial Unicode MS}{
    \newfontfamily\currencyfont{Arial Unicode MS}
    \typeout{Set currency font to Arial Unicode MS}
  }{
    \let\currencyfont\rmfamily
    \typeout{Warning: No currency font found for XeLaTeX}
  }
\fi

% Define fallback commands for special symbols
\newcommand{\fallbacksymbol}[2]{%
  \ifcsname symbolfont\endcsname%
    {{\symbolfont #1}}%
  \else%
    #2% fallback text
  \fi%
}

\newcommand{\fallbackcurrency}[2]{%
  \ifcsname currencyfont\endcsname%
    {{\currencyfont #1}}%
  \else%
    #2% fallback text
  \fi%
}

% Define specific missing symbol commands
% Enhanced symbol commands with multiple font fallbacks to eliminate warnings

% Currency symbols - use text abbreviations to avoid font issues
\DeclareRobustCommand{\rupee}{\textcolor{darkgray}{INR}}
\DeclareRobustCommand{\ruble}{\textcolor{darkgray}{RUB}}
\DeclareRobustCommand{\shekel}{\textcolor{darkgray}{ILS}}
\DeclareRobustCommand{\colon}{\textcolor{darkgray}{CRC}}
\DeclareRobustCommand{\cruzeiro}{\textcolor{darkgray}{BRC}}
\DeclareRobustCommand{\franc}{\textcolor{darkgray}{FRF}}
\DeclareRobustCommand{\lira}{\textcolor{darkgray}{ITL}}
\DeclareRobustCommand{\mill}{\textcolor{darkgray}{MILL}}
\DeclareRobustCommand{\naira}{\textcolor{darkgray}{NGN}}
\DeclareRobustCommand{\peseta}{\textcolor{darkgray}{ESP}}
\DeclareRobustCommand{\rupeeold}{\textcolor{darkgray}{PKR}}

% Special punctuation and symbols - use text fallbacks to avoid font issues
\DeclareRobustCommand{\tripleprime}{\textcolor{gray}{'''}}
\DeclareRobustCommand{\reversedSemicolon}{\textcolor{gray}{;}}
\DeclareRobustCommand{\hourglass}{%
  \ifcsname emojifont\endcsname%
    {{\emojifont â³}}%
  \else%
    \textcolor{orange}{[WAIT]}%
  \fi%
}
\DeclareRobustCommand{\infoSymbol}{%
  \ifcsname emojifont\endcsname%
    {{\emojifont â„¹}}%
  \else%
    \textcolor{blue}{[INFO]}%
  \fi%
}
\DeclareRobustCommand{\raisedFist}{%
  \ifcsname emojifont\endcsname%
    {{\emojifont âœŠ}}%
  \else%
    \textcolor{red}{[POWER]}%
  \fi%
}
\DeclareRobustCommand{\keyboardSymbol}{%
  \ifcsname emojifont\endcsname%
    {{\emojifont âŒ¨}}%
  \else%
    \textcolor{gray}{[KEYBOARD]}%
  \fi%
}

% Configure monospace fonts for all engines with CJK support
\ifluatex
  % LuaLaTeX monospace font configuration - prioritize SourceHanMono for code blocks
  % Use SourceHanMono for proper monospace code display with CJK support
  \IfFontExistsTF{Source Han Mono SC}{
    \setmonofont{Source Han Mono SC}[Scale=0.8,Renderer=HarfBuzz]
    \newfontfamily\codefont{Source Han Mono SC}[Scale=0.8,Renderer=HarfBuzz]
    \typeout{Set monospace font to Source Han Mono SC for CJK code support}
  }{
    \IfFontExistsTF{Source Han Sans SC}{
      \setmonofont{Source Han Sans SC}[Scale=0.8,Renderer=HarfBuzz]
      \newfontfamily\codefont{Source Han Sans SC}[Scale=0.8,Renderer=HarfBuzz]
      \typeout{Set monospace font to Source Han Sans SC for CJK support (fallback)}
    }{
      \IfFontExistsTF{PingFang SC}{
        \setmonofont{PingFang SC}[Scale=0.8,Renderer=HarfBuzz]
        \newfontfamily\codefont{PingFang SC}[Scale=0.8,Renderer=HarfBuzz]
        \typeout{Set monospace font to PingFang SC (macOS fallback with CJK)}
      }{
        \IfFontExistsTF{JetBrains Mono}{
          \setmonofont{JetBrains Mono}[
            Scale=0.8,
            BoldFont=JetBrains Mono Bold,
            Renderer=HarfBuzz
          ]
          \newfontfamily\codefont{JetBrains Mono}[Scale=0.8,Renderer=HarfBuzz]
          \typeout{Warning: Using JetBrains Mono - CJK characters may not display properly}
        }{
          \IfFontExistsTF{Fira Code}{
            \setmonofont{Fira Code}[
              Scale=0.8,
              BoldFont=Fira Code Bold,
              Renderer=HarfBuzz
            ]
            \newfontfamily\codefont{Fira Code}[Scale=0.8,Renderer=HarfBuzz]
          }{
            \setmonofont{Menlo}[Scale=0.8,Renderer=HarfBuzz]
            \newfontfamily\codefont{Menlo}[Scale=0.8,Renderer=HarfBuzz]
          }
        }
      }
    }
  }
\else
  % XeLaTeX monospace font configuration with CJK support
  % Use SourceHanMono for proper monospace code display with CJK support
  \IfFontExistsTF{Source Han Mono SC}{
    \setmonofont{Source Han Mono SC}[Scale=0.8]
    \newfontfamily\codefont{Source Han Mono SC}[Scale=0.8]
    \typeout{Set monospace font to Source Han Mono SC for CJK code support}
  }{
    \IfFontExistsTF{Source Han Sans SC}{
      \setmonofont{Source Han Sans SC}[Scale=0.8]
      \newfontfamily\codefont{Source Han Sans SC}[Scale=0.8]
      \typeout{Set monospace font to Source Han Sans SC for CJK support (fallback)}
    }{
      \IfFontExistsTF{PingFang SC}{
        \setmonofont{PingFang SC}[Scale=0.8]
        \newfontfamily\codefont{PingFang SC}[Scale=0.8]
        \typeout{Set monospace font to PingFang SC (macOS fallback with CJK)}
      }{
      \IfFontExistsTF{JetBrains Mono}{
        \setmonofont{JetBrains Mono}[
          Scale=0.8,
          BoldFont=JetBrains Mono Bold
        ]
        \newfontfamily\codefont{JetBrains Mono}[Scale=0.8]
        \typeout{Warning: Using JetBrains Mono - CJK characters may not display properly}
      }{
        \IfFontExistsTF{Fira Code}{
          \setmonofont{Fira Code}[
            Scale=0.8,
            BoldFont=Fira Code Bold
          ]
          \newfontfamily\codefont{Fira Code}[Scale=0.8]
        }{
          \setmonofont{Menlo}[Scale=0.8]
          \newfontfamily\codefont{Menlo}[Scale=0.8]
        }
      }
    }
  }
}
\fi

% Ensure codefont is always defined
\providecommand{\codefont}{\ttfamily}

% Define code background color - ä¸ä»£ç å—èƒŒæ™¯è‰²ä¸€è‡´
\definecolor{codebg}{rgb}{0.94,0.95,0.96}

% Define emoji-aware code font for use in code environments
$if(emoji)$
\newcommand{\emojicodefont}{\codefont}
$endif$

% Redefine texttt for inline code - keep truly inline for normal text
\let\oldtexttt\texttt
\renewcommand{\texttt}[1]{%
  \begingroup%
  \codefont\small%
  \setlength{\fboxsep}{1pt}%
  \colorbox{codebg}{%
    \hspace{1pt}%
    \mbox{#1}% Use mbox to prevent line breaks and ensure the background only covers the text
    \hspace{1pt}%
  }%
  \endgroup%
}

% Define a table-friendly inline code command that allows line breaks
\newcommand{\tablecode}[1]{%
  \begingroup%
  \codefont\small%
  \colorbox{codebg}{%
    \hspace{1pt}%
    \parbox{\linewidth}{%
      \raggedright%
      \hspace{0pt}% Enable hyphenation
      \textcolor{black}{#1}%
    }%
    \hspace{1pt}%
  }%
  \endgroup%
}

% Define a breakable inline code command for general use
\newcommand{\breakcode}[1]{%
  \begingroup%
  \codefont\small%
  \setlength{\fboxsep}{1pt}%
  \colorbox{codebg}{%
    \parbox[t]{\linewidth}{%
      \raggedright%
      \hspace{0pt}% Enable word breaking
      \allowbreak%
      \textcolor{black}{#1}%
      \allowbreak%
    }%
  }%
  \endgroup%
}

% Alternative inline code for tables - allows natural line breaking
\newcommand{\flexcode}[1]{%
  \begingroup%
  \codefont\small% Use small font for better readability
  % Use a simple approach: just apply font and color without background box
  % This prevents the "whole line background" issue in tables
  \textcolor{black}{#1}% Simple text formatting without colorbox
  \endgroup%
}

% Table inline code without background color - for cleaner table appearance
\newcommand{\tablecodenobackground}[1]{%
  \begingroup%
  \codefont\small% Use small font for better readability in tables
  % Simple boxed layout to reduce spacing issues
  \setlength{\fboxsep}{0.5pt}%
  \fcolorbox{gray}{white}{%
    \parbox[t]{\dimexpr\linewidth-6pt\relax}{%
      \raggedright%
      \tolerance=1000%
      \emergencystretch=1em%
      \hbadness=1000%
      \pretolerance=100%
      \hfuzz=0.1pt%
      \spaceskip=0.2em plus 0.08em minus 0.05em% Adjusted space stretching for inline content
      \setlength{\parskip}{0pt}%
      \setlength{\baselineskip}{1.05\baselineskip}% Adjusted line spacing
      \hspace{0pt}#1%
    }%
  }%
  \endgroup%
}

% Fix lstinline to support CJK characters by redefining it to use our enhanced texttt
\let\oldlstinline\lstinline
\renewcommand{\lstinline}[2][]{%
  \begingroup%
  \codefont\small%
  \setlength{\fboxsep}{1pt}%
  \colorbox{codebg}{%
    \hspace{1pt}%
    \parbox[t]{\dimexpr\linewidth-4pt\relax}{%
      \raggedright%
      \tolerance=9999%
      \emergencystretch=3em%
      \hbadness=10000%
      \hfuzz=0.1pt%
      \hspace{0pt}%
      \seqsplit{#2}%
    }%
    \hspace{1pt}%
  }%
  \endgroup%
}

% Header and footer
\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE,RO]{\thepage}
\fancyhead[RE]{\nouppercase{\leftmark}}
\fancyhead[LO]{\nouppercase{\rightmark}}
\fancyfoot[C]{\thepage}
\fancypagestyle{plain}{
    \fancyhf{}
    \fancyfoot[C]{\thepage}
    \renewcommand{\headrulewidth}{0pt}
}
% ä¿®æ­£ç« èŠ‚é¡µçœ‰æ ¼å¼ï¼Œæ˜¾ç¤ºâ€œç¬¬ N ç« ã€‚æ ‡é¢˜â€
\renewcommand{\chaptermark}[1]{%
  \markboth{ç¬¬\ \thechapter\ ç« ï¼š#1}{}
}

% Section formatting
\renewcommand{\chaptername}{ç¬¬}
\renewcommand{\thechapter}{\arabic{chapter}}

% ä¸­æ–‡ç›®å½•æ ‡é¢˜
\renewcommand{\contentsname}{ç›®å½•}

% ä¸­è‹±æ–‡æ··åˆæ’ç‰ˆä¼˜åŒ–é…ç½® - ä½¿ç”¨ ctex å†…å»ºæ”¯æŒ
% ctex å®åŒ…å·²ç»æä¾›äº†ä¼˜ç§€çš„ä¸­è‹±æ–‡æ··æ’æ”¯æŒ
% é…ç½®åŸºæœ¬çš„æ¢è¡Œå‚æ•°
\pretolerance=1000
\tolerance=2000
\emergencystretch=1em
\righthyphenmin=1
\lefthyphenmin=2

% é…ç½®ä¸­æ–‡æ–­è¡Œè®¾ç½® - æ ¹æ®å¼•æ“é€‰æ‹©
\ifluatex
  % LuaLaTeX ä½¿ç”¨ ctex çš„å†…å»ºä¸­æ–‡æ–­è¡Œæ”¯æŒ
  \typeout{Using LuaLaTeX Chinese line breaking}
\else
  % XeLaTeX ä½¿ç”¨ XeTeX çš„ä¸­æ–‡æ–­è¡Œè®¾ç½®
  \XeTeXlinebreaklocale "zh"
  \XeTeXlinebreakskip = 0pt plus 1pt minus 0.1pt
  \typeout{Using XeLaTeX Chinese line breaking}
\fi

% é…ç½®ä¸­è‹±æ–‡é—´è·ï¼ˆctex ä¼šè‡ªåŠ¨å¤„ç†ï¼‰
% æ³¨æ„ï¼š\ctexset å‘½ä»¤å·²ç§»åŠ¨åˆ° ctex åŒ…åŠ è½½ä¹‹å

% ç®€åŒ–çš„å¤šè¯­è¨€å­—ä½“æ”¯æŒé…ç½®
% ä½¿ç”¨æ›´ç®€å•ä½†æœ‰æ•ˆçš„æ–¹æ³•æ¥å¤„ç† emoji å’Œå¤šè¯­è¨€å­—ç¬¦
\typeout{Configuring simplified multilingual font support}

\titleformat{\chapter}[display]{\normalfont\huge\bfseries}{\chaptername\ \thechapter\ ç« }{20pt}{\Huge}
\titlespacing*{\chapter}{0pt}{-30pt}{40pt}
\titleformat{\section}{\normalfont\Large\bfseries}{\thesection}{1em}{}
\titlespacing*{\section}{0pt}{18pt plus 2pt minus 1pt}{14pt}
\titleformat{\subsection}{\normalfont\large\bfseries}{\thesubsection}{1em}{}
\titlespacing*{\subsection}{0pt}{16pt}{10pt}
\titleformat{\subsubsection}{\normalfont\normalsize\bfseries}{\thesubsubsection}{1em}{}
\titlespacing*{\subsubsection}{0pt}{14pt}{8pt}

% ç« èŠ‚å¼€å§‹æ—¶æ€»æ˜¯åœ¨æ–°é¡µ
\let\originalchapter\chapter
\renewcommand{\chapter}{\clearpage\originalchapter}

% itemize åˆ—è¡¨æ‰€æœ‰å±‚çº§éƒ½ç”¨åœ†ç‚¹
\renewcommand{\labelitemi}{\textbullet}
\renewcommand{\labelitemii}{\textbullet}
\renewcommand{\labelitemiii}{\textbullet}
\renewcommand{\labelitemiv}{\textbullet}

% Tightened list spacing using enumitem package
\setlist[itemize,1]{leftmargin=1.2em,label=\textbullet,itemsep=2pt,parsep=0pt}
\setlist[enumerate,1]{leftmargin=1.8em,itemsep=2pt,parsep=0pt}

% é‡æ–°å®šä¹‰ quote ç¯å¢ƒï¼Œä½¿ç”¨å·¦ä¾§ç«–çº¿æ ·å¼
\renewenvironment{quote}{%
  \begin{mdframed}[style=quotestyle]%
  $if(quote_color)$\color{quotecolor}$endif$% åº”ç”¨å¼•ç”¨æ–‡å­—é¢œè‰²
  % ä¸ä½¿ç”¨æ–œä½“ï¼Œä¿æŒæ­£å¸¸å­—ä½“
}{%
  \end{mdframed}%
}

% å®šä¹‰ blockquote ç¯å¢ƒï¼ˆPandoc ä½¿ç”¨è¿™ä¸ªï¼‰
\newenvironment{blockquote}{%
  \begin{mdframed}[style=quotestyle]%
  $if(quote_color)$\color{quotecolor}$endif$% åº”ç”¨å¼•ç”¨æ–‡å­—é¢œè‰²
  % ä¸ä½¿ç”¨æ–œä½“ï¼Œä¿æŒæ­£å¸¸å­—ä½“
}{%
  \end{mdframed}%
}

% å®šä¹‰ quotation ç¯å¢ƒï¼ˆå¯èƒ½çš„ Pandoc å¼•ç”¨ç¯å¢ƒï¼‰
\renewenvironment{quotation}{%
  \begin{mdframed}[style=quotestyle]%
  $if(quote_color)$\color{quotecolor}$endif$% åº”ç”¨å¼•ç”¨æ–‡å­—é¢œè‰²
  % ä¸ä½¿ç”¨æ–œä½“ï¼Œä¿æŒæ­£å¸¸å­—ä½“
}{%
  \end{mdframed}%
}

% å®šä¹‰ quoteblock ç¯å¢ƒï¼ˆå¤‡ç”¨ï¼‰
\newenvironment{quoteblock}{%
  \begin{mdframed}[style=quotestyle]%
  $if(quote_color)$\color{quotecolor}$endif$% åº”ç”¨å¼•ç”¨æ–‡å­—é¢œè‰²
  % ä¸ä½¿ç”¨æ–œä½“ï¼Œä¿æŒæ­£å¸¸å­—ä½“
}{%
  \end{mdframed}%
}

% --- Hyperref (must be loaded late) ---
\hypersetup{
    unicode=true,
    pdftoolbar=true,
    pdfmenubar=true,
    pdffitwindow=false,
    pdfstartview={FitH},
    pdftitle={$title$},
    pdfauthor={$author$},
    pdfsubject={$subject$},
    pdfcreator={$creator$},
    pdfproducer={$producer$},
    pdfkeywords={$keywords$},
    bookmarks=true,
    bookmarksopen=true,
    bookmarksopenlevel=2,
    bookmarksnumbered=true,
    bookmarkstype=toc,
    colorlinks=true,
    linkcolor=black,
    filecolor=black,
    urlcolor=blue,
    citecolor=black,
    linktoc=all
}

% --- Color Configuration ---
$if(body_color)$
\definecolor{bodycolor}{HTML}{$body_color$}
\color{bodycolor}
$endif$

$if(heading_color)$
\definecolor{headingcolor}{HTML}{$heading_color$}
\renewcommand{\normalcolor}{\color{headingcolor}}
$endif$

$if(link_color)$
\definecolor{linkcolor}{HTML}{$link_color$}
\hypersetup{linkcolor=linkcolor, urlcolor=linkcolor, citecolor=linkcolor}
$endif$

$if(code_color)$
% Convert HTML color to RGB values
\definecolor{codecolor}{RGB}{221,20,0}
$endif$

$if(quote_color)$
\definecolor{quotecolor}{HTML}{$quote_color$}
% æ›´æ–° quotestyle çš„æ–‡å­—é¢œè‰²è€Œä¸æ˜¯é‡æ–°å®šä¹‰æ•´ä¸ªç¯å¢ƒ
\mdfdefinestyle{quotestyle}{
    backgroundcolor=quotebg,
    linecolor=quoteborder,
    linewidth=4pt,           % å·¦ä¾§ç«–çº¿å®½åº¦ - å¢åŠ åˆ° 4pt ä½¿ç«–çº¿æ›´æ˜æ˜¾
    leftline=true,           % åªæ˜¾ç¤ºå·¦ä¾§çº¿
    rightline=false,
    topline=false,
    bottomline=false,
    leftmargin=8pt,          % å¤–éƒ¨å·¦è¾¹è·ï¼Œä½¿æ•´ä¸ªå¼•ç”¨å—å‘å³ç¼©è¿›
    rightmargin=0pt,
    innerleftmargin=20pt,    % å·¦ä¾§å†…è¾¹è·ï¼Œæ–‡æœ¬ä¸ç«–çº¿çš„è·ç¦»
    innerrightmargin=12pt,
    innertopmargin=10pt,     % å¢åŠ ä¸Šä¸‹å†…è¾¹è·
    innerbottommargin=10pt,
    skipabove=15pt,          % å¼•ç”¨å—å‰çš„é—´è·
    skipbelow=15pt,          % å¼•ç”¨å—åçš„é—´è·
    roundcorner=0pt,
    splittopskip=\topskip,   % è·¨é¡µæ—¶é¡¶éƒ¨é—´è·
    splitbottomskip=0pt,     % è·¨é¡µæ—¶åº•éƒ¨é—´è·
    everyline=true           % æ¯ä¸€è¡Œéƒ½åº”ç”¨æ ·å¼
}
$endif$

% --- Document Body ---
\begin{document}


% Cover Page
$if(cover-image)$
$if(cover_title_text)$
% Custom cover with text overlay
\newpage
\thispagestyle{empty}
\pagenumbering{gobble}

% Set cover background
\AddToShipoutPicture*{%
    \AtPageLowerLeft{%
        \includegraphics[width=\paperwidth,height=\paperheight,keepaspectratio]{$cover-image$}%
    }%
}

% Cover text setup with improved layout
\vspace*{0pt}

% Title section - positioned in upper third
$if(cover_title_text)$
$if(cover_title_color)$
\definecolor{covertitlecolor}{HTML}{$cover_title_color$}
$endif$
\vspace*{0.15\textheight}
\begin{center}
{\fontsize{$if(cover_title_font_size)$$cover_title_font_size$$else$48$endif$pt}{$if(cover_title_line_height)$$cover_title_line_height$$else$65$endif$pt}\selectfont
$if(cover_title_color)$\color{covertitlecolor}$endif$
\parbox{0.9\textwidth}{\centering\textbf{$cover_title_text$}}}
\end{center}
$endif$

% Subtitle section - right below title with minimal spacing
$if(cover_subtitle_text)$
$if(cover_subtitle_color)$
\definecolor{coversubtitlecolor}{HTML}{$cover_subtitle_color$}
$endif$
\vspace{0.03\textheight}
\begin{center}
{\fontsize{$if(cover_subtitle_font_size)$$cover_subtitle_font_size$$else$18$endif$pt}{$if(cover_subtitle_line_height)$$cover_subtitle_line_height$$else$24$endif$pt}\selectfont
$if(cover_subtitle_color)$\color{coversubtitlecolor}$endif$
\parbox{0.9\textwidth}{\centering $cover_subtitle_text$}}
\end{center}
$endif$

% Flexible space to push bottom content down
\vfill

% Author section - positioned at bottom
$if(cover_author_text)$
$if(cover_author_color)$
\definecolor{coverauthorcolor}{HTML}{$cover_author_color$}
$endif$
\begin{center}
{\fontsize{$if(cover_author_font_size)$$cover_author_font_size$$else$24$endif$pt}{$if(cover_author_line_height)$$cover_author_line_height$$else$32$endif$pt}\selectfont
$if(cover_author_color)$\color{coverauthorcolor}$endif$
$cover_author_text$}
\end{center}
$endif$

% Export date section - positioned below author
$if(cover_export_date)$
$if(cover_subtitle_color)$
\definecolor{coverdatecolor}{HTML}{$cover_subtitle_color$}
$else$
\definecolor{coverdatecolor}{HTML}{C0C0C0}
$endif$
\vspace{0.02\textheight}
\begin{center}
{\fontsize{14pt}{14pt}\selectfont
\color{coverdatecolor}
$cover_export_date$}
\end{center}
$endif$

% Bottom margin
\vspace*{0.08\textheight}
\clearpage
\ClearShipoutPicture

$else$
% Standard cover without text overlay
\includepdf[pages={1},pagecommand={\thispagestyle{empty}},width=\paperwidth]{$cover-image$}
$endif$
$endif$

% Title Page (Commented out - removed as the cover already contains the book info)
% \newcommand{\mytitlepage}{
%     \thispagestyle{empty}
%     \begin{center}
%     \vspace*{2cm}
%     {\Huge\bfseries $title$\par}
%     \vspace{1cm}
%     {\Large $author$\par}
%     \vspace{1.5cm}
%     {\large $date$\par}
%     $if(exported)$
%     \vspace{0.8cm}
%     {\normalsize å¯¼å‡ºæ—¶é—´ï¼š$exported$\par}
%     $endif$
%     $if(website)$
%     \vspace{0.5cm}
%     {\normalsize åœ¨çº¿é˜…è¯»ï¼š\url{$website$\par}
%     $endif$
%     \vfill
%     \end{center}
%     \newpage
%     \setcounter{page}{1}
% }
% \mytitlepage

% Table of Contents - prevent blank page after cover
\clearpage
\thispagestyle{empty} % Clear header style
\pdfbookmark[0]{ç›®å½•}{toc}

% åœ¨ç”Ÿæˆç›®å½•ä¹‹å‰ç«‹å³è®¾ç½®æ ¼å¼
\makeatletter
% è®¾ç½®ç« èŠ‚ç¼–å·å®½åº¦ - ç¡®ä¿ç¼–å·å’Œæ ‡é¢˜ä¹‹é—´æœ‰è¶³å¤Ÿé—´è·
\setlength{\cftchapnumwidth}{2em}
\setlength{\cftsecnumwidth}{3em}
\setlength{\cftsubsecnumwidth}{4em}
\setlength{\cftsubsubsecnumwidth}{5em}

% è®¾ç½®ç« èŠ‚æ ‡é¢˜ç¼©è¿› - æ¢å¤æ­£å¸¸å±‚çº§ç¼©è¿›
\setlength{\cftchapindent}{1em}
\setlength{\cftsecindent}{2em}
\setlength{\cftsubsecindent}{3em}
\setlength{\cftsubsubsecindent}{4em}

% ç¡®ä¿ç‚¹çº¿æ˜¾ç¤º
\renewcommand{\cftchapdotsep}{\cftdotsep}
\renewcommand{\cftsecdotsep}{\cftdotsep}
\renewcommand{\cftsubsecdotsep}{\cftdotsep}
\renewcommand{\cftsubsubsecdotsep}{\cftdotsep}

% è®¾ç½®ç« èŠ‚æ ¼å¼
\renewcommand{\cftchapfont}{\bfseries}
\renewcommand{\cftchappagefont}{\bfseries}
\renewcommand{\cftsecfont}{\normalfont}
\renewcommand{\cftsubsecfont}{\normalfont}
\renewcommand{\cftsubsubsecfont}{\normalfont}

% è®¾ç½®ç« èŠ‚é—´è·
\setlength{\cftbeforechapskip}{1em}
\setlength{\cftbeforesecskip}{0.5em}
\setlength{\cftbeforesubsecskip}{0em}
\setlength{\cftbeforesubsubsecskip}{0em}
\makeatother

\tableofcontents
% é¿å…ç›®å½•åçš„ç©ºç™½é¡µ
\let\cleardoublepage\relax
\clearpage
\pagenumbering{arabic}
\setcounter{page}{1}

% Reset to left alignment for main content
\raggedright

% è®¾ç½®ä¹¦ç­¾æ·±åº¦
\setcounter{tocdepth}{4}
\setcounter{secnumdepth}{4}

% Main Content
$body$

% Back Cover
$if(backcover-image)$
\clearpage
\thispagestyle{empty}
\pagenumbering{gobble}

% Set backcover background to fill entire page
\AddToShipoutPicture*{%
    \AtPageLowerLeft{%
        \includegraphics[width=\paperwidth,height=\paperheight,keepaspectratio=false]{$backcover-image$}%
    }%
}

% Define back cover colors with defaults
$if(backcover_text_color)$
\definecolor{backcovertext}{HTML}{$backcover_text_color$}
$else$
\definecolor{backcovertext}{HTML}{000000}  % Default black
$endif$

$if(backcover_link_color)$
\definecolor{backcoverlink}{HTML}{$backcover_link_color$}
$else$
\definecolor{backcoverlink}{HTML}{0066CC}  % Default blue
$endif$

% Enhanced back cover layout with configurable positioning
\vspace*{$if(backcover_top_margin)$$backcover_top_margin$$else$0.2\textheight$endif$}

\begin{center}

% Back cover text section
$if(backcover_text)$
{\fontsize{$if(backcover_text_font_size)$$backcover_text_font_size$$else$16$endif$pt}{$if(backcover_text_line_height)$$backcover_text_line_height$$else$24$endif$pt}\selectfont
\color{backcovertext}
\parbox{0.8\textwidth}{\centering $backcover_text$}}

\vspace{$if(backcover_spacing_1)$$backcover_spacing_1$$else$1.5cm$endif$}
$endif$

% QR code section
$if(qrcode_image)$
\includegraphics[width=$if(qrcode_size)$$qrcode_size$$else$0.15\paperwidth$endif$]{$qrcode_image$}

\vspace{$if(backcover_spacing_2)$$backcover_spacing_2$$else$1cm$endif$}
$endif$

% Website link section - use local hypersetup to override global link colors
\begingroup
\hypersetup{
    linkcolor=backcoverlink,
    urlcolor=backcoverlink,
    citecolor=backcoverlink
}
$if(backcover_link_text)$
$if(backcover_link_url)$
{\fontsize{$if(backcover_link_font_size)$$backcover_link_font_size$$else$14$endif$pt}{$if(backcover_link_line_height)$$backcover_link_line_height$$else$20$endif$pt}\selectfont
\href{$backcover_link_url$}{$backcover_link_text$}}
$else$
{\fontsize{$if(backcover_link_font_size)$$backcover_link_font_size$$else$14$endif$pt}{$if(backcover_link_line_height)$$backcover_link_line_height$$else$20$endif$pt}\selectfont
\color{backcoverlink}
$backcover_link_text$}
$endif$
$else$
% Fallback to website URL if no custom link text
$if(website)$
{\fontsize{$if(backcover_link_font_size)$$backcover_link_font_size$$else$14$endif$pt}{$if(backcover_link_line_height)$$backcover_link_line_height$$else$20$endif$pt}\selectfont
\url{$website$}}
$endif$
$endif$
\endgroup

\end{center}

\vspace*{$if(backcover_bottom_margin)$$backcover_bottom_margin$$else$0.2\textheight$endif$}
$endif$

\end{document}
